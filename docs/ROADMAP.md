# Cueplay 项目现状梳理与后续规划

本文档总结了 Cueplay 当前的技术实现情况，并结合项目愿景规划了后续的开发路线。

## 1. 已实现功能梳理

### 核心架构
- **跨平台底座**：基于 Tauri 2.0 + Next.js 15 的架构，支持 macOS、Windows（iOS/Android 处于工程化验证阶段）。
- **模块化设计**：核心逻辑拆分为 `playback-core` (播放), `sync-core` (同步), `room-core` (房间), `protocol` (协议) 等独立包，便于维护和扩展。
- **国际化 (i18n)**：完整的中文/英文界面支持，且解决了服务端渲染 (SSR) 导致的水合 (Hydration) 错误。

### 播放能力
- **夸克网盘集成**：深度的夸克网盘集成能力，支持 Cookie 注入、CDN 地址智能解析及自动续期。
- **高性能播放**：集成 `hls.js`，支持 4K 高清流式播放，并配合系统级代理（Proxy）解决跨域及 Cookie 鉴权问题。
- **自动续期实现**：
    - **登录**：通过扫码捕获 `__pus`（持久化会话）和 `__puus` 长效令牌，实现身份持久化。
    - **播放**：通过 `RecoveryManager` 捕获 403/410 错误，自动调用 `refreshPlayableSource` 进行 CDN 链接的静默重解析。
    - **兜底**：API 层面支持全局 Cookie 回退策略，确保房间内用户即时 Cookie 失效也能继续播放。
- **智能字幕系统**：
  - **精准居中**：通过自定义字幕层绕过原生限制，实现垂直居中对齐。
  - **全屏优化**：全屏下字幕位置自适应，避开进度条遮挡。
  - **容错处理**：自动清除超时（8s+）的常驻字幕，修复部分 SRT/VTT 文件的格式瑕疵。

### 同步机制
- **权威时间线模型**：采用房主（Controller）主导的权威同步，通过实时 WebSocket 广播状态。
- **平滑漂移补偿**：
  - **软同步 (Soft Sync)**：通过微调 `playbackRate` 实现毫秒级平滑对齐。
  - **硬同步 (Hard Sync)**：当时间差超过阈值（1.2s）时自动触发 seek 指令。
  - **延迟对齐**：使用 `sentAt` 时间戳进行端到端延迟补偿。

### 交互与 UI
- **现代影视化 UI**：基于玻璃拟态 (Glassmorphism) 的响应式设计，包含浮动控制条、动态进度反馈等。
- **资源库管理**：
  - 支持文件列表预览、剧集/文件夹自动解析。
  - 集成关键词快速搜索及列表/网格视图切换。
- **播放列表功能**：支持 Dnd-kit 拖拽排序、进度自动保存（每 5s）、自动续播逻辑。
- **社交互动**：内置轻量级实时聊天室及成员管理功能。

---

## 2. 后续规划 (Roadmap)

### 阶段一：稳固与打磨 (P0)
- [ ] **多平台发布**：正式完成 iOS 和 Android 的编译适配，优化触屏操作交互。
- [ ] **同步算法优化**：针对极端网络环境（高抖动、长延迟）进行更稳健的状态机优化，减少频繁 seek。
- [ ] **移动端体验**：优化手机端布局（Mobile Layout），确保留海屏适配及手势操作体验。

### 阶段二：能力扩展 (P1)
- [ ] **更多存储源支持**：
  - [ ] **WebDAV**：打通阿里云盘、个人 NAS 资源。
  - [ ] **本地流化**：支持将本地文件通过局域网直接推送到房间（WebRTC 或边缘推流）。
- [ ] **播放控制补全**：增加多音轨切换、视频比例调节（拉伸/填充）、画面后处理（亮度/对比度）。
- [ ] **AI 辅助**：集成端侧 AI 助手，支持语音控制播放及剧情摘要生成。

### 阶段三：社交与生态 (P2)
- [ ] **实时通讯增强**：集成 WebRTC 的多人语音/视频连麦功能。
- [ ] **沉浸式互动**：支持播放过程中的表情包弹幕、关键剧情点打卡。
- [ ] **插件架构**：开放播放 Provider 插件 API，让社区可以轻松接入新的网盘或视频源。

---

## 3. 技术债务与待优化
- [ ] **单一文件治理**：目前 `room/page.tsx` 逻辑较重（1700+ 行），需进一步拆分为更细粒度的 Hooks 和组件。
- [ ] **状态管理升级**：考虑引入 Zustand 或 Jotai 替代部分复杂的原生 `useState`，提升性能。
- [ ] **代码覆盖率**：针对核心 `sync-core` 增加单元测试。
