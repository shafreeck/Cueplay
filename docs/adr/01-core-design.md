# CuePlay：核心功能方案（ADR 01）

> 本文档描述 CuePlay 的**核心功能方案与系统级设计决策**，用于约束后续模块拆分与实现顺序。 本文不涉及具体代码实现，而是给出稳定、可演进、不返工的总体设计。

---

## 0. 系统定位与设计前提

### 0.1 产品定位

CuePlay 是一个：

- **原生优先**的一起看片工具
- 面向**熟人/小圈子**使用
- 以**播放体验与同步稳定性**为第一优先级

它不是视频平台、不做内容分发、不追求 Web 覆盖率最大化。

### 0.2 现实约束

- 夸克视频播放 **必须完整 Cookie**
- Cookie 泄露在该模式下 **不可避免**
- Web 端受浏览器安全模型限制，不能作为第一阶段主路径

因此系统必须引入：

- 授权租约（体验层）
- 物理登出（安全止血层）

---

## 1. 系统能力分层

CuePlay 的系统能力被明确拆分为三层：

```
┌───────────────────────────┐
│        表现层（UI）        │
│ 播放器 / 房间 / 授权界面 │
└────────────▲──────────────┘
             │
┌────────────┴──────────────┐
│        控制层（同步）      │
│ 房间 / 同步 / 权限 / 租约 │
└────────────▲──────────────┘
             │
┌────────────┴──────────────┐
│        播放层（端侧）      │
│ 夸克直连 / Cookie / Range │
└───────────────────────────┘
```

三层之间必须解耦：

- 控制层不接触视频流
- 播放层不感知房间/成员逻辑
- UI 层不直接操作 Cookie

---

## 2. 视频播放方案（核心能力）

### 2.1 播放优先级

CuePlay 明确以下播放优先级：

1. **原生端直连夸克播放（第一阶段必须完成）**
   - 桌面端（Tauri）
   - 移动端（iOS / Android）
2. 桌面浏览器插件（可选）
3. 服务端代理播放（Web 端兜底，非第一阶段目标）

---

### 2.2 原生端播放总体流程

1. 端侧持有夸克完整 Cookie（安全存储）
2. 使用 Cookie 调用夸克接口，解析真实 CDN 播放地址
3. 播放器通过 HTTP Range 方式拉取视频分片
4. 若播放地址过期，端侧自动刷新并无感续播

**关键技术点**：

- 必须支持 `Range / 206 Partial Content`
- 必须处理 302 跳转至 CDN
- 必须支持播放中 URL 失效后的自动恢复

---

### 2.3 播放 Provider 抽象

为避免后续返工，播放源统一抽象为 Provider：

```
PlayableProvider
  ├─ resolvePlayableSource()
  ├─ refreshPlayableSource()
  └─ openStream(range)
```

当前实现：

- `QuarkProvider`

未来可扩展：

- 本地文件
- WebDAV
- 其它网盘

同步与房间模块 **不感知具体 Provider**。

---

## 3. 房间与消息同步方案

### 3.1 房间模型

- 房间是一次一起看片的基本单元
- 每个房间有且只有一个 **权威者（Leader / 房主）**

房间核心状态：

- 当前播放媒体
- 播放状态（playing / paused）
- 播放位置（position）
- 播放速率（rate）

---

### 3.2 同步模型（Leader 权威）

CuePlay 采用 **单一权威时间线模型**：

- Leader 周期性广播权威播放状态（1–2 秒）
- 其他成员被动对齐

客户端对齐策略：

- 小漂移：微调 playbackRate
- 大漂移：强制 seek

该模型简单、稳定、可预测，适合小圈子协作。

---

### 3.3 同步通道

- 使用 WebSocket 长连接
- 所有控制事件走控制面服务器
- 视频流量 **不经过服务器**

---

## 4. 权限与授权管理方案

### 4.1 权限域划分

#### A. 服务管理权限（Service Admin）

- 由服务管理员（你本人）掌控
- 管理共享夸克账号的 Cookie
- 负责安全事故的 **物理止血**

#### B. 房间管理权限（Room Owner）

- 房主管理房间内的播放授权
- 决定哪些设备可以使用 Cookie 播放

---

### 4.2 两层授权模型

#### 第一层：租约（Lease）——体验层

- 授权对象：**设备实例**
- 可过期、可撤销
- 决定“此设备是否允许使用 Cookie”

#### 第二层：物理登录 Cookie——安全层

- 真正的夸克登录态
- 通过夸克登出接口失效
- 仅用于安全事故止血

---

### 4.3 授权流程概览

1. 设备加入房间，请求播放授权
2. 房主批准并下发租约
3. 租约有效期内允许播放
4. 房主撤销租约：设备立即停播并清除 Cookie
5. 若发生泄露风险：服务管理员触发夸克登出

---

## 5. Cookie 管理与安全边界

### 5.1 现实前提

- 播放必须完整 Cookie
- Cookie 泄露不可避免

### 5.2 工程化减损策略

- Cookie 仅通过端到端加密分发
- Cookie 仅存储于系统安全存储
- Cookie 使用强制绑定租约状态
- 必须支持“一键止血”

CuePlay 的目标不是绝对安全，而是**风险可控、责任清晰、可承担后果**。

---

## 6. 模块责任边界（概览）

| 模块    | 责任                  |
| ----- | ------------------- |
| 播放模块  | 视频播放、恢复、Provider 管理 |
| 同步模块  | 播放状态同步、时间线对齐        |
| 房间模块  | 房间生命周期、成员管理         |
| 授权模块  | 租约、Cookie 分发与撤销     |
| 服务管理  | 服务级 Cookie、物理登出     |
| UI 模块 | 播放界面、房间控制、授权确认      |

---

## 7. 第一阶段明确不做的事情

- 公共内容平台
- 视频上传 / 转码 / 分发
- Web 端直连夸克播放
- P2P 作为主路径
- 大规模并发优化

---

## 8. 阶段性成功标准（MVP）

CuePlay 第一阶段成功的判断标准：

1. 原生端播放稳定、顺滑
2. 多人同步不漂、不乱
3. 授权与撤销可控、不失控

只要满足这三点，其它能力都可以后续演进。

